# Estrutura Multi-tenant PocketBase ‚Äî m

Implementamos a base multi-tenant do sistema no banco usando PocketBase, j√° preparada para isolamento de dados entre diferentes clientes (tenants) desde o desenvolvimento.

## Estrutura das Cole√ß√µes

### 1. m24_clientes
- Cadastro central de cada cliente (tenant).
- Campo `documento` (CPF ou CNPJ) obrigat√≥rio e √∫nico, para identifica√ß√£o fiscal e integra√ß√µes.


#### Tabela de Campos

| Campo | Descri√ß√£o |
|-------|-----------|
| `documento` | CPF ou CNPJ do cliente, usado em integra√ß√µes. |
| `nome` | Nome ou raz√£o social do cliente. |
| `dominio` | Endere√ßo principal configurado. |
| `tipo_dominio` | Indica se o cliente usa subdom√≠nio ou dom√≠nio pr√≥prio. |
| `verificado` | Confirma se o dom√≠nio est√° validado. |
| `modo_validacao` | M√©todo adotado para valida√ß√£o do dom√≠nio. |
| `logo_url` | URL do logotipo exibido na plataforma. |
| `cor_primary` | Cor principal utilizada na personaliza√ß√£o. |
| `responsavel_nome` | Nome da pessoa respons√°vel. |
| `responsavel_email` | E-mail de contato do respons√°vel. |
| `ativo` | Indica se o cliente est√° ativo no sistema. |
| `created` | Data de cria√ß√£o do cadastro. |

### 2. clientes_config
- Mapeia cada dom√≠nio para o ID do cliente correspondente (`cliente`).
- Serve de ponte para que fun√ß√µes como `getTenantFromHost` identifiquem o tenant a partir do hostname.

### 3. Cole√ß√µes filhas (usuarios, produtos, pedidos, inscricoes)
- Todas possuem campo de rela√ß√£o obrigat√≥ria `cliente` (refer√™ncia √† cole√ß√£o `clientes`).
- Isso garante que todo registro esteja sempre vinculado a um cliente.

## Permiss√µes e L√≥gica Multi-tenant

- Todas queries, leituras e grava√ß√µes devem ser filtradas pelo campo `cliente`.
- **√â obrigat√≥rio que toda cria√ß√£o, edi√ß√£o, atualiza√ß√£o ou exclus√£o de usu√°rios, pedidos, inscri√ß√µes, compras e quaisquer outros registros SEMPRE inclua o campo `cliente`, vinculando corretamente ao cliente (tenant) em quest√£o.**
- O fluxo de autentica√ß√£o, consulta ou cadastro deve sempre:
  1. **Procurar primeiro o cliente** (tenant) usando `documento` (CPF/CNPJ) ou dom√≠nio.
  2. **Isolar todas as opera√ß√µes** usando o ID do cliente (campo `cliente`).
  3. Garantir que cada usu√°rio veja/edite apenas dados do seu pr√≥prio cliente (tenant).

> **Exemplo de filtro em query:**
> Buscar pedidos apenas do cliente autenticado:
> ```js
> pb.collection('pedidos').getFullList({ filter: `cliente='ID_DO_CLIENTE'` })
> ```

- O escopo do usu√°rio (coordenador, lider, usuario) deve ser respeitado dentro do tenant.

As rotas de servidor (`/api`) chamam `getTenantFromHost` para identificar o cliente pelo dom√≠nio. Essa fun√ß√£o consulta `clientes_config` e retorna o ID que ser√° usado para buscar as credenciais em `m24_clientes`.

## Benef√≠cios

- Estrutura pronta para SaaS: escal√°vel, segura, pronta para deploy em nuvem.
- F√°cil integra√ß√£o com pagamentos, notas fiscais e automa√ß√µes.
- Permiss√µes e isolamento j√° padronizados desde o desenvolvimento local.

---

> Adote este padr√£o multi-tenant em toda a aplica√ß√£o, SEMPRE consultando, criando e isolando pelo cliente antes de qualquer outra opera√ß√£o ‚Äî isso inclui obrigatoriamente toda cria√ß√£o, edi√ß√£o e atualiza√ß√£o de registros nas cole√ß√µes filhas. Assim, a transi√ß√£o para produ√ß√£o ser√° transparente e segura.


# Integra√ß√£o Multi-tenant com Asaas (Subcontas)

## 1. Uso de Subcontas e API Key do Asaas

* **Cada cliente (tenant) possui sua pr√≥pria subconta no Asaas.**
* Para cada subconta, armazene com seguran√ßa a respectiva **API Key** (ex: campo `asaas_api_key` na cole√ß√£o `m24_clientes`).
* Toda opera√ß√£o de cobran√ßa, consulta ou emiss√£o de pagamento deve sempre utilizar a **API Key da subconta do cliente envolvido**.
* **Nunca exponha a API Key de nenhuma subconta no frontend.** Toda requisi√ß√£o ao Asaas deve ser feita via backend, buscando a chave correta do cliente antes de qualquer chamada.

## 2. Webhook do Asaas em ambiente multi-tenant

* O webhook do Asaas aponta para um √∫nico endpoint:

  ```
  https://SEUDOMINIO.com/api/asaas/webhook
  ```
* Ao receber uma notifica√ß√£o:

  1. **Identifique a subconta do evento** (usando `accountId` do payload ou relacionando pelo `id_pagamento` ao pedido/inscri√ß√£o).
  2. Busque no banco o cliente dono da subconta (`m24_clientes.asaas_api_key` ou `m24_clientes.asaas_account_id`).
  3. Atualize registros apenas desse cliente.
  4. Registre/logue o evento para concilia√ß√£o.

## 3. Fluxo multi-tenant usando subcontas

* Sempre que interagir com o Asaas, busque a **API Key da subconta** do cliente respons√°vel:

  ```js
  // Exemplo: buscar chave da subconta
  const cliente = await pb.collection('m24_clientes').getOne(CLIENTE_ID)
  const apiKey = cliente.asaas_api_key
  // Usar apiKey na autentica√ß√£o das chamadas
  ```

* O campo `asaas_account_id` tamb√©m pode ser salvo para facilitar matching no webhook.

* **Pedidos est√£o sempre vinculados a inscri√ß√µes, enquanto compras realizadas na loja n√£o t√™m rela√ß√£o com inscri√ß√µes.**

* **Ao criar um pedido ou compra, envie o campo `externalReference` (externalID) com uma estrutura clara que permita identificar o `cliente`, o `usuario` e, quando aplic√°vel, a `inscricao`.**

  * Exemplo de formato:

    ```json
    {
      "externalReference": "cliente_abc123_usuario_xyz789_inscricao_456def"
    }
    ```
  * Para compras sem inscri√ß√£o:

    ```json
    {
      "externalReference": "cliente_abc123_usuario_xyz789"
    }
    ```
  * No webhook, o backend deve extrair esse identificador e us√°-lo para localizar com seguran√ßa o cliente e o usu√°rio respons√°veis pela transa√ß√£o.

## 4. Seguran√ßa

* Armazene as API Keys das subcontas em campo seguro. Nunca exponha ao frontend.
* O backend deve garantir que nenhuma opera√ß√£o de um cliente utilize a API Key de outro.

---

> Toda integra√ß√£o com o Asaas deve buscar e utilizar a API Key da subconta correta do cliente (tenant) em todas as etapas (cria√ß√£o de cobran√ßa, consultas, webhooks, etc). O sistema deve garantir o isolamento completo das opera√ß√µes financeiras entre clientes, tanto nas requisi√ß√µes quanto no processamento dos eventos retornados pelo Asaas. O campo `externalReference` deve ser sempre preenchido com um identificador claro que contenha a origem da transa√ß√£o (cliente, usu√°rio e, se aplic√°vel, inscri√ß√£o).

# Requisitos Funcionais - M√≥dulo Financeiro (Integra√ß√£o com Asaas)

## üìÉ User Stories

### Transfer√™ncias externas (Pix ou TED)

* **Como** usu√°rio administrador da conta, **quero** realizar uma transfer√™ncia externa para conta banc√°ria ou chave Pix, **para** sacar saldo ou enviar valores externos.

  * Deve suportar: valor, conta banc√°ria (banco, ag√™ncia, conta, tipo), ou chave Pix (tipo e valor), agendamento opcional, descri√ß√£o e `externalReference`.

### Transfer√™ncia interna (entre contas Asaas)

* **Como** usu√°rio administrador, **quero** transferir entre minha conta Asaas e subcontas vinculadas, **para** distribuir saldos.

  * Deve solicitar `walletId` da conta de destino, com transfer√™ncia imediata e sem custos.

### Consultar transfer√™ncias

* **Como** administrador, **quero** listar todas as transfer√™ncias feitas, **para** acompanhar hist√≥rico com pagina√ß√£o e filtros.
* **Como** administrador, **quero** recuperar detalhes de uma transfer√™ncia espec√≠fica por `id`, **para** analisar status e dados retornados.

### Cancelar transfer√™ncia agendada

* **Como** administrador, **quero** cancelar uma transfer√™ncia agendada externa antes da execu√ß√£o, **para** evitar envio indevido.

### Consultar saldo da conta

* **Como** administrador, **quero** recuperar meu saldo atual dispon√≠vel via API, **para** tomar decis√µes financeiras.

### Outras informa√ß√µes financeiras

* **Como** administrador, **quero** ver estat√≠sticas de cobran√ßas e valores de split, **para** analisar receitas e repasses.

---

## üîç Caso de Uso ‚Äì ‚ÄúFazer transfer√™ncia externa via Pix/TED‚Äù

* **Nome**: Transfer√™ncia Externa

* **Atores**: Administrador

* **Pr√©-condi√ß√£o**:

  * Usu√°rio autenticado com permiss√£o `transfer.create`
  * Saldo dispon√≠vel ‚â• valor solicitado

* **Fluxo Principal**:

  1. Usu√°rio escolhe ‚ÄúTransfer√™ncia Externa‚Äù na UI
  2. Seleciona m√©todo: ‚ÄúConta banc√°ria‚Äù ou ‚ÄúPix‚Äù
  3. Preenche dados: valor, conta/chave Pix, data opcional e descri√ß√£o
  4. (Opcional) Insere `externalReference`
  5. Confirma e clica em ‚ÄúEnviar‚Äù
  6. Sistema chama `POST /v3/transfers`

     * Se `pixAddressKey`: Pix
     * Se `bankAccount`: TED
  7. Exibe status (sucesso ou erro)

* **Fluxos Alternativos**:

  * Dados inv√°lidos: mostrar mensagem por campo
  * Erro HTTP 409: exibir erro de duplicidade

* **Requisitos Funcionais**:

  1. Validar campos obrigat√≥rios (valor > 0, dados banc√°rios ou Pix)
  2. Suportar `externalReference`
  3. Escolha autom√°tica entre Pix/TED conforme dados
  4. Tratar status HTTP e exibir resposta
  5. Permitir cancelamento de transfer√™ncias agendadas

* **Riscos**:

  * HTTP 409 por duplicidade
  * Uso incorreto da chave Pix pode redirecionar fundos

---

## üìÜ Caso de Uso ‚Äì ‚ÄúConsultar saldo‚Äù

* **Nome**: Visualizar Saldo

* **Atores**: Administrador

* **Pr√©-condi√ß√£o**: Conta autenticada

* **Fluxo Principal**:

  1. Usu√°rio acessa aba Financeiro
  2. Seleciona ‚ÄúVer Saldo‚Äù
  3. Chama `GET /v3/account/balance`
  4. Exibe: saldo dispon√≠vel, saldo em processamento, limite, etc.

* **Requisitos Funcionais**:

  * Mostrar todos os campos retornados pela API
  * Atualizar informa√ß√£o em tempo real

* **Riscos**:

  * Necess√°ria interpreta√ß√£o correta de cada campo financeiro

---

## ‚úÖ Sum√°rio dos Requisitos

| ID       | User Story                         | Endpoint Asaas            | Requisitos principais                                           |
| -------- | ---------------------------------- | ------------------------- | --------------------------------------------------------------- |
| US-FT-01 | Transfer√™ncia externa Pix/TED      | POST /v3/transfers        | valor, conta/chave, agendamento, descri√ß√£o, `externalReference` |
| US-FT-02 | Transfer√™ncia interna entre contas | POST /v3/transfers        | `walletId`, transfer√™ncia imediata                              |
| US-FT-03 | Listar transfer√™ncias              | GET /v3/transfers         | pagina√ß√£o, filtros                                              |
| US-FT-04 | Detalhes da transfer√™ncia          | GET /v3/transfers/{id}    | status, dados da opera√ß√£o                                       |
| US-FT-05 | Cancelar transfer√™ncia             | DELETE /v3/transfers/{id} | antes da execu√ß√£o                                               |
| US-FT-06 | Consultar saldo                    | GET /v3/account/balance   | mostrar todos os campos da resposta                             |
| US-FT-07 | Estat√≠sticas e split               | GET endpoints financeiros | dados consolidados                                              |

---

## üìå Requisitos N√£o Funcionais

1. **Desempenho**:

   * As opera√ß√µes de listagem e consulta devem responder em at√© 2 segundos para at√© 100 itens.
   * Transfer√™ncias devem ser registradas em at√© 1 segundo ap√≥s confirma√ß√£o.

2. **Seguran√ßa**:

   * Todas as chamadas √† API devem ser autenticadas via token seguro.
   * Dados banc√°rios devem ser criptografados em tr√¢nsito e em repouso.

3. **Disponibilidade**:

   * O sistema deve estar dispon√≠vel 99,5% do tempo mensal.
   * API de integra√ß√£o com o Asaas deve ter fallback para indisponibilidade tempor√°ria.

4. **Escalabilidade**:

   * A aplica√ß√£o deve ser capaz de suportar 1000 transfer√™ncias simult√¢neas sem degrada√ß√£o.

5. **Auditabilidade**:

   * Toda solicita√ß√£o de transfer√™ncia deve ser registrada com timestamp, IP de origem e identificador do usu√°rio.

6. **Usabilidade**:

   * A UI deve fornecer mensagens de erro claras em caso de falha.
   * Campos devem ter valida√ß√£o instant√¢nea no frontend.

7. **Conformidade**:

   * O m√≥dulo financeiro deve seguir as diretrizes da LGPD e normas do BACEN para opera√ß√µes financeiras eletr√¥nicas.
