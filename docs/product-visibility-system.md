# üîç Sistema de Visibilidade Hier√°rquica de Produtos

## üìã Vis√£o Geral

O sistema de visibilidade hier√°rquica controla **onde e para quem** os produtos s√£o exibidos com base na hierarquia territorial e no sistema de aprova√ß√µes. Implementa as regras de neg√≥cio definidas:

- **Coordenador Geral**: Produtos vis√≠veis nacionalmente (autom√°tico)
- **Coordenador Regional**: Produtos vis√≠veis em toda a regi√£o (autom√°tico) ou precisa aprova√ß√£o para n√≠vel estadual
- **L√≠der Local**: Produtos vis√≠veis na cidade (autom√°tico) ou precisa aprova√ß√£o para n√≠veis superiores

## üéØ Regras de Visibilidade

### **N√≠veis de Visibilidade**
```typescript
type NivelVisibilidade = 
  | 'cidade'        // Apenas na cidade do l√≠der
  | 'regiao'        // Toda a regi√£o
  | 'estado'        // Todo o estado  
  | 'nacional'      // Todo o pa√≠s
```

### **Matriz de Aprova√ß√µes**

| N√≠vel do Usu√°rio | Pode Publicar Direto | Precisa Aprova√ß√£o |
|------------------|---------------------|-------------------|
| **L√≠der Local** | `cidade` | `regiao` (Coord. Regional)<br/>`estado` (Coord. Geral)<br/>`nacional` (Coord. Geral) |
| **Coord. Regional** | `cidade`, `regiao` | `estado` (Coord. Geral)<br/>`nacional` (Coord. Geral) |
| **Coord. Geral** | `cidade`, `regiao`, `estado`, `nacional` | *(nenhum)* |

### **Fluxo de Aprova√ß√£o**

```mermaid
graph TD
    A[Produto Criado] --> B{N√≠vel Solicitado}
    B -->|Cidade| C[Publica√ß√£o Imediata]
    B -->|Regi√£o| D{Criador √© Coord. Regional+?}
    B -->|Estado| E{Criador √© Coord. Geral?}
    B -->|Nacional| F{Criador √© Coord. Geral?}
    
    D -->|Sim| C
    D -->|N√£o| G[Aguarda Aprova√ß√£o Regional]
    
    E -->|Sim| C  
    E -->|N√£o| H[Aguarda Aprova√ß√£o Estadual]
    
    F -->|Sim| C
    F -->|N√£o| H
    
    G --> I[Coord. Regional Analisa]
    H --> J[Coord. Geral Analisa]
    
    I -->|Aprova| K[Produto Vis√≠vel na Regi√£o]
    I -->|Rejeita| L[Produto Mantido na Cidade]
    
    J -->|Aprova| M[Produto Vis√≠vel no Estado/Nacional]
    J -->|Rejeita| N[Produto Mantido no N√≠vel Atual]
```

## üèóÔ∏è Arquitetura T√©cnica

### **Componentes Principais**

#### 1. **ProdutoVisibilidade**
Controla a visibilidade de cada produto:
```typescript
type ProdutoVisibilidade = {
  produto_id: string
  criado_por: string
  nivel_criador: NivelHierarquia
  nivel_visibilidade_atual: NivelVisibilidade
  nivel_visibilidade_solicitado: NivelVisibilidade
  status_autorizacao: StatusAutorizacao
  territorios_visiveis: {
    estados: string[]
    regioes: string[]  
    cidades: string[]
  }
  // ... outros campos
}
```

#### 2. **SolicitacaoAprovacao**
Gerencia pedidos de amplia√ß√£o de visibilidade:
```typescript
type SolicitacaoAprovacao = {
  produto_id: string
  solicitante_id: string
  nivel_atual: NivelVisibilidade
  nivel_solicitado: NivelVisibilidade
  justificativa: string
  aprovador_necessario: NivelHierarquia
  status: StatusAutorizacao
  produto_info: {
    performance_atual: PerformanceProduto
  }
}
```

#### 3. **Engine de Visibilidade**
Filtros autom√°ticos que determinam quais produtos cada usu√°rio v√™:
```typescript
// Exemplo de filtro para usu√°rio em S√£o Paulo/Zona Sul
const filtroVisibilidade = `
  (territorios_visiveis.cidades ~ "sp-zona-sul") ||
  (territorios_visiveis.regioes ~ "sao-paulo-capital") ||
  (territorios_visiveis.estados ~ "sao-paulo") ||
  (territorios_visiveis.estados ~ "*")
`
```

## üöÄ Funcionalidades Implementadas

### **1. Cria√ß√£o de Produto com Visibilidade**
```typescript
// L√≠der Local criando produto
await criarProdutoComVisibilidade(
  produtoId: "prod_123",
  criadoPor: "lider_zona_sul",
  nivelCriador: "lider_local",
  nivelVisibilidadeSolicitado: "regiao", // Precisa aprova√ß√£o
  territorioUsuario: {
    estado_id: "sao-paulo",
    regiao_id: "capital", 
    cidade_id: "zona-sul"
  }
)
// Resultado: Produto fica vis√≠vel apenas na cidade at√© aprova√ß√£o
```

### **2. Solicita√ß√£o de Amplia√ß√£o**
```typescript
await solicitarAlteracaoVisibilidade(
  produtoVisibilidadeId: "vis_123",
  novoNivelVisibilidade: "estado",
  solicitanteId: "coord_regional_sp",
  justificativa: "Produto tem alta demanda em todo o estado"
)
// Cria solicita√ß√£o para Coordenador Geral aprovar
```

### **3. Processamento de Aprova√ß√£o**
```typescript
await processarAprovacao(
  solicitacaoId: "sol_456",
  aprovadorId: "coord_geral_sp", 
  acao: "aprovar",
  comentarios: "Produto tem potencial. Aprovado para todo o estado."
)
// Atualiza visibilidade e envia notifica√ß√µes
```

### **4. Consulta de Produtos Vis√≠veis**
```typescript
const produtos = await buscarProdutosVisiveis(
  usuarioId: "cliente_abc",
  territorioUsuario: {
    estado_id: "sao-paulo",
    regiao_id: "capital",
    cidade_id: "zona-oeste"
  }
)
// Retorna apenas produtos vis√≠veis para este territ√≥rio
```

## üìä Dashboard de Aprova√ß√µes

### **M√©tricas Principais**
- **Pendentes de Aprova√ß√£o**: Solicita√ß√µes aguardando an√°lise
- **Taxa de Aprova√ß√£o**: % de solicita√ß√µes aprovadas vs. rejeitadas  
- **Tempo M√©dio**: Tempo entre solicita√ß√£o e decis√£o
- **Produtos em Destaque**: Mais solicitados para amplia√ß√£o

### **Funcionalidades do Dashboard**
- ‚úÖ **An√°lise Detalhada**: Performance, justificativa, hist√≥rico
- ‚úÖ **Aprova√ß√£o R√°pida**: Bot√µes de a√ß√£o direta
- ‚úÖ **Filtros Avan√ßados**: Por n√≠vel, status, per√≠odo
- ‚úÖ **Notifica√ß√µes**: Alertas para solicita√ß√µes urgentes
- ‚úÖ **Hist√≥rico**: Auditoria completa de decis√µes

## üîç Casos de Uso Pr√°ticos

### **Caso 1: Produto Local com Potencial**
```
1. L√≠der de Campinas cria "Curso de Excel Avan√ßado"
2. Produto fica vis√≠vel apenas em Campinas
3. Vendas crescem 200% no primeiro m√™s
4. L√≠der solicita visibilidade regional: "Alta demanda em cidades vizinhas"
5. Coordenador Regional aprova para toda regi√£o de Campinas
6. Produto agora vis√≠vel em Americana, Sumar√©, Valinhos, etc.
```

### **Caso 2: Produto Inovador Estadual**
```  
1. Coordenador Regional do Rio cria "Sistema de Energia Solar"
2. Produto fica vis√≠vel em toda regi√£o metropolitana
3. Performance excepcional com avalia√ß√£o 4.9
4. Coordenador solicita n√≠vel estadual: "Produto inovador sem concorr√™ncia"
5. Coordenador Geral analisa e aprova para todo estado do RJ
6. Produto vis√≠vel em Campos, Petr√≥polis, Angra dos Reis, etc.
```

### **Caso 3: Produto Nacional**
```
1. Coordenador Geral cria "Plataforma de Gest√£o M24"
2. Sistema detecta n√≠vel autom√°tico: nacional
3. Produto imediatamente vis√≠vel em todo o Brasil
4. Sem necessidade de aprova√ß√£o adicional
```

## ‚öôÔ∏è Configura√ß√µes e Regras

### **Limites por N√≠vel**
```typescript
const LIMITES_USUARIO = {
  lider_local: 10,        // M√°x 10 produtos pendentes
  coordenador_regional: 25, // M√°x 25 produtos pendentes  
  coordenador_geral: 100    // M√°x 100 produtos pendentes
}
```

### **Tempo M√°ximo para Aprova√ß√£o**
```typescript
const TEMPO_MAXIMO_APROVACAO = {
  cidade: 0,      // Imediato
  regiao: 24,     // 24 horas
  estado: 48,     // 48 horas
  nacional: 72    // 72 horas
}
```

### **Crit√©rios de Auto-Aprova√ß√£o** *(Futuro)*
```typescript
const CRITERIOS_AUTO_APROVACAO = {
  nota_minima_produto: 4.5,
  vendas_minimas_mes: 50,
  avaliacao_vendedor_minima: 4.0,
  sem_denuncias_dias: 30
}
```

## üìà Analytics e Relat√≥rios

### **M√©tricas de Visibilidade**
- **Alcance por Produto**: Quantos territ√≥rios cada produto atinge
- **Performance por N√≠vel**: Vendas por n√≠vel de visibilidade
- **Taxa de Convers√£o**: Efetividade da amplia√ß√£o de visibilidade
- **Produtos Trending**: Mais solicitados para amplia√ß√£o

### **Relat√≥rios Dispon√≠veis**
- üìä **Relat√≥rio de Produtos por Visibilidade**
- üìà **Performance de Aprova√ß√µes por Coordenador**
- üéØ **Produtos com Maior Potencial de Expans√£o**
- ‚è±Ô∏è **Tempo de Resposta de Aprova√ß√µes**

## üîê Seguran√ßa e Auditoria

### **Controles de Acesso**
- ‚úÖ **Verifica√ß√£o de Permiss√µes**: Usu√°rio pode gerenciar/aprovar?
- ‚úÖ **Valida√ß√£o de Territ√≥rio**: Dentro da jurisdi√ß√£o?
- ‚úÖ **Limite de Solicita√ß√µes**: Respeita limites por n√≠vel?
- ‚úÖ **Hist√≥rico Completo**: Todas as altera√ß√µes registradas

### **Auditoria**
```typescript
type AprovacaoHistorico = {
  tipo: 'criacao' | 'solicitacao_aprovacao' | 'aprovacao' | 'rejeicao'
  nivel_anterior?: NivelVisibilidade
  nivel_solicitado: NivelVisibilidade
  solicitante_id: string
  aprovador_id?: string
  comentarios?: string
  data: string
}
```

## üöÄ APIs Principais

### **Criar Produto com Visibilidade**
```http
POST /api/produtos/visibilidade
{
  "produto_id": "prod_123",
  "nivel_visibilidade_solicitado": "regiao",
  "territorio_usuario": {
    "estado_id": "sp",
    "regiao_id": "capital", 
    "cidade_id": "zona-sul"
  }
}
```

### **Solicitar Altera√ß√£o de Visibilidade**
```http
POST /api/produtos/visibilidade/{id}/solicitar-alteracao
{
  "novo_nivel_visibilidade": "estado",
  "justificativa": "Alta demanda em todo o estado"
}
```

### **Processar Aprova√ß√£o**
```http
PUT /api/solicitacoes-aprovacao/{id}/processar
{
  "acao": "aprovar", // ou "rejeitar"
  "comentarios": "Produto tem potencial. Aprovado."
}
```

### **Buscar Produtos Vis√≠veis**
```http
GET /api/produtos/visiveis?territorio=sp-capital-zona-oeste&categoria=eletronicos
```

## üîÑ Integra√ß√µes

### **Sistema de Notifica√ß√µes**
- üìß **Email**: Notifica√ß√µes de solicita√ß√µes e decis√µes
- üîî **Push**: Alertas em tempo real no painel
- üì± **SMS**: Notifica√ß√µes urgentes (opcional)

### **Sistema de Analytics**
- üìä **M√©tricas de Produto**: Integra√ß√£o com analytics de vendas
- üìà **Performance Tracking**: Acompanhamento p√≥s-aprova√ß√£o
- üéØ **A/B Testing**: Testes de visibilidade regional

### **Sistema de Cache**
- ‚ö° **Cache de Filtros**: Filtros de visibilidade em Redis
- üîÑ **Invalida√ß√£o Autom√°tica**: Cache atualizado nas aprova√ß√µes
- üìä **Cache de M√©tricas**: Dashboard com dados em cache

## üìã Checklist de Implementa√ß√£o

### **Fase 1: Core System** ‚úÖ
- [x] Tipos TypeScript para visibilidade
- [x] Servi√ßos de controle de visibilidade  
- [x] Sistema de aprova√ß√µes
- [x] Dashboard de aprova√ß√µes

### **Fase 2: UX/UI** 
- [ ] Interface de solicita√ß√£o para vendedores
- [ ] Notifica√ß√µes em tempo real
- [ ] Mobile-first design
- [ ] Integra√ß√£o com WhatsApp

### **Fase 3: Analytics**
- [ ] Relat√≥rios de performance
- [ ] M√©tricas de convers√£o por territ√≥rio
- [ ] An√°lise de potencial de produtos
- [ ] Dashboard executivo

### **Fase 4: Otimiza√ß√µes**
- [ ] Auto-aprova√ß√£o baseada em crit√©rios
- [ ] Machine Learning para recomenda√ß√µes
- [ ] Cache avan√ßado com edge computing
- [ ] Sistema de alertas inteligentes

## üéØ Benef√≠cios do Sistema

### **Para L√≠deres Locais**
- üöÄ **Expans√£o Controlada**: Amplie alcance com aprova√ß√£o
- üìä **Dados de Performance**: Justifique solicita√ß√µes com m√©tricas
- üéØ **Foco Local**: Produtos relevantes para sua regi√£o
- üí° **Oportunidades**: Identifique produtos com potencial

### **Para Coordenadores Regionais**
- ‚öñÔ∏è **Controle de Qualidade**: Aprove apenas produtos adequados
- üìà **Vis√£o Regional**: Produtos com potencial em toda regi√£o
- üîç **An√°lise Detalhada**: Performance completa antes da decis√£o
- ‚è±Ô∏è **Efici√™ncia**: Dashboard otimizado para decis√µes r√°pidas

### **Para Coordenadores Gerais**
- üåç **Vis√£o Estrat√©gica**: Produtos com potencial nacional
- üìä **Analytics Completos**: M√©tricas de toda a hierarquia
- üéØ **Produtos Premium**: Apenas os melhores chegam ao n√≠vel estadual
- üöÄ **Escalabilidade**: Sistema preparado para crescimento

### **Para o Neg√≥cio**
- üí∞ **Mais Vendas**: Produtos certos nos territ√≥rios certos
- üéØ **Relev√¢ncia**: Produtos locais para demandas locais
- üìà **Growth**: Expans√£o org√¢nica baseada em performance
- üõ°Ô∏è **Qualidade**: Controle de qualidade distribu√≠do

## üìû Suporte e Recursos

### **Documenta√ß√£o T√©cnica**
- [API Reference](./api-product-visibility.md)
- [Database Schema](./schema-product-visibility.sql)
- [Deployment Guide](./deployment-visibility.md)
- [Troubleshooting](./troubleshooting-visibility.md)

### **Guias de Uso**
- [Guia do L√≠der Local](./guide-local-leader.md)
- [Guia do Coordenador Regional](./guide-regional-coordinator.md)
- [Guia do Coordenador Geral](./guide-general-coordinator.md)
- [FAQ Sistema de Visibilidade](./faq-visibility.md)